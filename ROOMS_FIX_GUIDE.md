# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –° –ö–û–ú–ù–ê–¢–ê–ú–ò

## üêõ **–ü—Ä–æ–±–ª–µ–º–∞:**
- –°—Ç–∞—Ä—ã–µ –∫–æ–º–Ω–∞—Ç—ã –≤–∏—Å—è—Ç 5 –¥–Ω–µ–π
- –•–æ—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –∑–∞–π—Ç–∏ –≤ —Å–≤–æ—é –∫–æ–º–Ω–∞—Ç—É
- –ö–æ–º–Ω–∞—Ç—ã –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## ‚úÖ **–†–µ—à–µ–Ω–∏–µ:**

### 1Ô∏è‚É£ **–í—ã–ø–æ–ª–Ω–∏—Ç—å SQL —Å–∫—Ä–∏–ø—Ç –≤ Supabase**

–û—Ç–∫—Ä–æ–π—Ç–µ **Supabase Dashboard** ‚Üí **SQL Editor** ‚Üí –≤—Å—Ç–∞–≤—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `FIX_ROOMS_CLEANUP.sql` –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ.

–°–∫—Ä–∏–ø—Ç —Å–¥–µ–ª–∞–µ—Ç:
- ‚úÖ –£–¥–∞–ª–∏—Ç –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –∫–æ–º–Ω–∞—Ç—ã
- ‚úÖ –°–æ–∑–¥–∞—Å—Ç —Ñ—É–Ω–∫—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏
- ‚úÖ –î–æ–±–∞–≤–∏—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- ‚úÖ –î–æ–±–∞–≤–∏—Ç —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### 2Ô∏è‚É£ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞**

–ö–æ–º–Ω–∞—Ç—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—å—Å—è:
- **1 —á–∞—Å** - –∫–æ–º–Ω–∞—Ç—ã –≤ —Å—Ç–∞—Ç—É—Å–µ `waiting` (–æ–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤)
- **3 —á–∞—Å–∞** - –∫–æ–º–Ω–∞—Ç—ã –≤ —Å—Ç–∞—Ç—É—Å–µ `playing` (–∏–¥–µ—Ç –∏–≥—Ä–∞)
- **1 –¥–µ–Ω—å** - –∫–æ–º–Ω–∞—Ç—ã –≤ —Å—Ç–∞—Ç—É—Å–µ `finished` (–∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞)

### 3Ô∏è‚É£ **API –¥–ª—è —Ä—É—á–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏**

–£–∂–µ –µ—Å—Ç—å API endpoint: `GET /api/rooms/cleanup`

–ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–Ω–∞—Ç.

### 4Ô∏è‚É£ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL —Å–∫—Ä–∏–ø—Ç–∞:

```sql
SELECT 
  COUNT(*) as total_rooms,
  COUNT(*) FILTER (WHERE status = 'waiting') as waiting_rooms,
  COUNT(*) FILTER (WHERE status = 'playing') as playing_rooms,
  COUNT(*) FILTER (WHERE status = 'finished') as finished_rooms
FROM _pidr_rooms;
```

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å **0 –∫–æ–º–Ω–∞—Ç** –∏–ª–∏ —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ.

## üéØ **–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**

### **–î–æ:**
- ‚ùå –ö–æ–º–Ω–∞—Ç—ã –≤–∏—Å–µ–ª–∏ –≤–µ—á–Ω–æ
- ‚ùå –•–æ—Å—Ç –Ω–µ –º–æ–≥ –∑–∞–π—Ç–∏ –≤ —Å–≤–æ—é –∫–æ–º–Ω–∞—Ç—É
- ‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞—Å–æ—Ä—è–ª–∞—Å—å

### **–ü–æ—Å–ª–µ:**
- ‚úÖ –ö–æ–º–Ω–∞—Ç—ã —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –•–æ—Å—Ç –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —á–∏—Å—Ç–∞—è

## üöÄ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:**

### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ pg_cron (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `pg_cron` –≤ Supabase:

```sql
-- –í–∫–ª—é—á–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
SELECT cron.schedule(
  'cleanup-rooms',
  '*/30 * * * *',
  'SELECT cleanup_inactive_rooms()'
);
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö cron jobs:**

```sql
SELECT * FROM cron.job;
```

## üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç:

```sql
SELECT 
  status,
  COUNT(*) as count,
  MAX(created_at) as last_created,
  MAX(last_activity) as last_activity
FROM _pidr_rooms
GROUP BY status;
```

## ‚ö†Ô∏è **–í–∞–∂–Ω–æ:**

1. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç –û–î–ò–ù –†–ê–ó**
2. **–ù–µ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –¥—É–±–ª–∏–∫–∞—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π/—Ç—Ä–∏–≥–≥–µ—Ä–æ–≤**
3. **–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç**

## üéâ **–ì–æ—Ç–æ–≤–æ!**

–¢–µ–ø–µ—Ä—å –∫–æ–º–Ω–∞—Ç—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞—Ç—å—Å—è, –∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å "–≤–∏—Å—è—â–∏–º–∏" –∫–æ–º–Ω–∞—Ç–∞–º–∏ —Ä–µ—à–µ–Ω–∞!

