import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import * as bcrypt from 'bcryptjs';
import { createSession } from '@/lib/auth/redis-session-manager';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL || '';
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || '';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { username, email, phone, password } = body;

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!username || !password) {
      return NextResponse.json(
        { success: false, message: '–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' },
        { status: 400 }
      );
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ username
    if (username.length < 3 || username.length > 32) {
      return NextResponse.json(
        { success: false, message: '–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 3 –¥–æ 32 —Å–∏–º–≤–æ–ª–æ–≤' },
        { status: 400 }
      );
    }

    if (!/^[a-zA-Z0-9_]+$/.test(username)) {
      return NextResponse.json(
        { success: false, message: '–õ–æ–≥–∏–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _' },
        { status: 400 }
      );
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –ø–∞—Ä–æ–ª—è
    if (password.length < 6) {
      return NextResponse.json(
        { success: false, message: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤' },
        { status: 400 }
      );
    }

    if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(password)) {
      return NextResponse.json(
        { success: false, message: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–ª–∞–≤–Ω—É—é –±—É–∫–≤—É, —Å—Ç—Ä–æ—á–Ω—É—é –±—É–∫–≤—É –∏ —Ü–∏—Ñ—Ä—É' },
        { status: 400 }
      );
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ email (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      return NextResponse.json(
        { success: false, message: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email' },
        { status: 400 }
      );
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
    if (phone && !/^\+?[1-9]\d{1,14}$/.test(phone)) {
      return NextResponse.json(
        { success: false, message: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç)' },
        { status: 400 }
      );
    }

    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username
    const { data: existingUser } = await supabase
      .from('_pidr_users')
      .select('id')
      .eq('username', username)
      .single();

    if (existingUser) {
      return NextResponse.json(
        { success: false, message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' },
        { status: 409 }
      );
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º email (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
    if (email) {
      const { data: existingEmail } = await supabase
        .from('_pidr_users')
        .select('id')
        .eq('email', email)
        .single();

      if (existingEmail) {
        return NextResponse.json(
          { success: false, message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' },
          { status: 409 }
        );
      }
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
    if (phone) {
      const { data: existingPhone } = await supabase
        .from('_pidr_users')
        .select('id')
        .eq('phone', phone)
        .single();

      if (existingPhone) {
        return NextResponse.json(
          { success: false, message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' },
          { status: 409 }
        );
      }
    }

    // –•–µ—à–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å
    const passwordHash = await bcrypt.hash(password, 10);

    // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const { data: newUser, error: createError } = await supabase
      .from('_pidr_users')
      .insert({
        username,
        email: email || null,
        phone: phone || null,
        password_hash: passwordHash,
        auth_method: 'local',
        coins: 1000,
        rating: 0,
        email_verified: false,
        phone_verified: false,
        is_active: true,
        login_count: 1,
        last_login_at: new Date().toISOString()
      })
      .select()
      .single();

    if (createError || !newUser) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', createError);
      return NextResponse.json(
        { success: false, message: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' },
        { status: 500 }
      );
    }

    // –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é –≤ Redis + JWT —Ç–æ–∫–µ–Ω
    const { token } = await createSession({
      userId: newUser.id.toString(),
      username: newUser.username,
      authMethod: 'local',
      email: newUser.email || undefined,
      phone: newUser.phone || undefined,
      userAgent: request.headers.get('user-agent') || undefined,
      ip: request.headers.get('x-forwarded-for')?.split(',')[0] || 
          request.headers.get('x-real-ip') || undefined,
    });

    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –ø–∞—Ä–æ–ª—è)
    const userData = {
      id: newUser.id,
      username: newUser.username,
      email: newUser.email,
      phone: newUser.phone,
      coins: newUser.coins,
      rating: newUser.rating,
      avatar_url: newUser.avatar_url,
      auth_method: newUser.auth_method,
      games_played: newUser.games_played || 0,
      games_won: newUser.games_won || 0,
      wins: newUser.wins || 0,
      losses: newUser.losses || 0
    };

    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', username);

    const response = NextResponse.json({
      success: true,
      message: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞',
      user: userData,
      token
    });

    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º cookie —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    const isProduction = process.env.NODE_ENV === 'production' || process.env.VERCEL === '1';
    const cookieSettings = {
      httpOnly: true,
      secure: isProduction, // –ù–∞ Vercel –≤—Å–µ–≥–¥–∞ true
      sameSite: 'lax' as const,
      maxAge: 30 * 24 * 60 * 60, // 30 –¥–Ω–µ–π
      path: '/'
    };
    
    response.cookies.set('auth_token', token, cookieSettings);
    
    console.log('üç™ [Register] Cookie —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', {
      hasToken: !!token,
      tokenLength: token.length,
      settings: cookieSettings,
      isProduction,
      vercel: process.env.VERCEL
    });

    return response;

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
    return NextResponse.json(
      { success: false, message: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' },
      { status: 500 }
    );
  }
}

